/*! bhsclient 2014-12-01 */
"use strict";angular.module("main",["ngResource","ngAnimate","ui.bootstrap","ui.router","lang","auth","apiClient","cache"]).config(["$urlRouterProvider","$stateProvider","$locationProvider","$httpProvider",function(a,b,c){var d=[{name:"start",url:"/",templateUrl:"templates/main/start.html",onEnter:["cache","wizard",function(a,b){a.clear(),b.clear()}]},{name:"404",url:"/404",templateUrl:"templates/main/404.html"},{name:"wizard-result",url:"/wizard-result?place&name",templateUrl:"templates/main/wizard-result.html",controller:"WizardResultCtrl as wizardResultController"},{name:"item-view",url:"/item/:id",templateUrl:"templates/main/item.html",controller:"ItemCtrl as itemController"}];angular.forEach(d,function(a){b.state(a)}),a.otherwise("/404"),c.html5Mode(!0)}]).run(["$state",function(a){a.go("start")}]),void 0===Object.prototype.isEmpty&&(Object.prototype.isEmpty=function(){return 0===Object.keys(this).length?!0:!1}),void 0===Object.prototype.isNotEmpty&&(Object.prototype.isNotEmpty=function(){return 0===Object.keys(this).length?!1:!0}),void 0===Array.prototype.isEmpty&&(Array.prototype.isEmpty=function(){return 0===this.length?!0:!1}),void 0===Array.prototype.isNotEmpty&&(Array.prototype.isNotEmpty=function(){return 0===this.length?!1:!0});var HeaderCtrl=function(a){this.search_placeholders={en:"Search for communities, last names and personalities",he:"חפשו קהילות, פירושי שמות משפחה ואישים"},Object.defineProperty(this,"notification_message",{get:function(){return a.get()}})};HeaderCtrl.prototype={},angular.module("main").controller("HeaderCtrl",["notification",HeaderCtrl]);var ItemCtrl=function(a,b,c,d){var e=this;this.in_progress=!0,this.content_loaded=!1,this.failed=!1,c.clear(),Object.defineProperty(this,"item_type",{get:function(){return d.get_type(this.item_data.UnitType)}}),c.put({en:"Fetching item...",he:"טוען פריט..."}),b.get(a.id).then(function(a){e.item_data=a,e.content_loaded=!0,c.put({en:"Item loaded successfuly.",he:"הפריט נטען בהצלחה."})},function(){e.failed=!0,c.put({en:"Failed to fetch item.",he:"טעינת פריט נכשלה."})}).finally(function(){e.in_progress=!1})};ItemCtrl.prototype={},angular.module("main").controller("ItemCtrl",["$stateParams","item","notification","itemTypeMap",ItemCtrl]);var ItemPreviewCtrl=function(a,b,c){this.$state=a,b.item_type=c.get_type(b.preview_data.UnitType)};ItemPreviewCtrl.prototype={goto_item:function(a){this.$state.go("item-view",{id:a._id.$oid})}},angular.module("main").controller("ItemPreviewCtrl",["$state","$scope","itemTypeMap",ItemPreviewCtrl]);var MainCtrl=function(a,b,c,d){this.$state=a,this.langManager=b,this.search_again_visible=!1,this.placeholders={name:{en:"Surname",he:"שם משפחה"},place:{en:"Place of Origin",he:"מקום"}},this.wizard_query={name:"",place:""},Object.defineProperty(this,"wizard_suggestions",{get:function(){return c.result.suggestions}}),Object.defineProperty(this,"lang",{get:function(){return b.lang},set:function(a){b.lang=a,window.localStorage.language=a}}),Object.defineProperty(this,"show_notifications",{get:function(){return a.includes("start")?!1:!0}}),Object.defineProperty(this,"signed_in_user",{get:function(){return d.signed_in_user}}),Object.defineProperty(this,"name_placeholder",{get:function(){return this.placeholders.name[b.lang]}}),Object.defineProperty(this,"place_placeholder",{get:function(){return this.placeholders.place[b.lang]}}),Object.defineProperty(this,"submit_disabled",{get:function(){return""==this.wizard_query.name&&""==this.wizard_query.place?!0:!1}})};MainCtrl.prototype={start:function(){this.search_again_visible=!0,this.$state.go("wizard-result",{name:this.wizard_query.name,place:this.wizard_query.place})},start_name:function(a){var b=this.langManager.lang[0].toUpperCase()+this.langManager.lang[1];this.wizard_query.name=a.Header[b],this.start()},start_place:function(a){var b=this.langManager.lang[0].toUpperCase()+this.langManager.lang[1];this.wizard_query.place=a.Header[b],this.start()}},angular.module("main").controller("MainCtrl",["$state","langManager","wizard","authManager",MainCtrl]);var WizardResultCtrl=function(a,b,c,d){var e=this;this.in_progress=!0,this.failed=!1,this.search_status="none",this.suggestion_status="none",this.notification=d,Object.defineProperty(this,"result",{get:function(){return c.result}}),Object.defineProperty(this,"last_search",{get:function(){return c.last_search}}),a.mainController.wizard_query.name=b.name,a.mainController.wizard_query.place=b.place,d.put({en:"Searching...",he:"מחפש..."}),c.search(b.name,b.place).then(function(a){try{a.bingo.name.isNotEmpty()||a.bingo.place.isNotEmpty()?a.bingo.name.isNotEmpty()&&a.bingo.place.isEmpty()?(e.search_status="bingo-name",d.put({en:"We have not found a community to match your search.",he:"לא מצאנו את הקהילה שחיפשתם."})):a.bingo.name.isEmpty()&&a.bingo.place.isNotEmpty()?(e.search_status="bingo-place",d.put({en:"We have not found a surname to match your search.",he:"לא מצאנו את שם המפשחה שחיפשתם."})):(e.search_status="bingo",d.put({en:"Search finished successfuly.",he:"החיפוש הסתיים בהצלחה."})):(e.search_status="none",d.put({en:"We have not found a name and community to match your search.",he:"לא מצאנו את שם המשפחה והקהילה שחיפשתם."})),a.suggestions.name.isNotEmpty()||a.suggestions.place.isNotEmpty()?(d.add({en:"Try using our suggestions below, or search again.",he:"נסו להעזר בהצעות שלנו מטה, או חפשו שוב."}),e.suggestion_status=a.suggestions.name.isNotEmpty()&&a.suggestions.place.isEmpty()?"name":a.suggestions.name.isEmpty()&&a.suggestions.place.isNotEmpty()?"place":"both"):e.suggestion_status="none"}catch(b){e.fail()}},function(){e.fail()}).finally(function(){e.in_progress=!1})};WizardResultCtrl.prototype={fail:function(){this.failed=!0,this.notification.put({en:"Search has failed.",he:"החיפוש נכשל."})}},angular.module("main").controller("WizardResultCtrl",["$scope","$stateParams","wizard","notification",WizardResultCtrl]),angular.module("main").directive("animateDown",[function(){return{restrict:"EA",scope:{trigger:"=when"},link:function(a,b){a.$watch("trigger",function(a){var c=document.querySelector("#search-again");if(c){var d=c.offsetHeight;b.css("-webkit-transition","all 0.7s ease"),b.css("-moz-transition","all 0.7s ease"),b.css("-o-transition","all 0.7s ease"),b.css("-ms-transition","all 0.7s ease"),b.css("transition","all 0.7s ease"),a!==!0?(b.css("-webkit-transform","translate(0,0)"),b.css("-moz-transform","translate(0,0)"),b.css("-o-transform","translate(0,0)"),b.css("-ms-transform","translate(0,0)"),b.css("transform","translate(0,0)")):(b.css("-webkit-transform","translate(0, "+d+"px)"),b.css("-moz-transform","translate(0, "+d+"px)"),b.css("-o-transform","translate(0, "+d+"px)"),b.css("-ms-transform","translate(0, "+d+"px)"),b.css("transform","translate(0, "+d+"px)"))}})}}}]),angular.module("main").directive("fitThumb",["$timeout",function(a){return{restrict:"A",scope:!0,link:function(b,c){a(function(){var a,b=c[0].naturalWidth,d=c[0].naturalHeight;void 0!==b&&void 0!==d&&(a=d/b,1>a?c.css("height","100%"):c.css("width","100%"))})}}}]),angular.module("main").directive("icon",["langManager",function(a){return{restrict:"E",replace:!0,templateUrl:"templates/main/icon.html",scope:{source:"@",altText:"=",position:"=",hoverOffset:"="},link:function(b,c){void 0===b.source&&(b.default_source="images/icons.png"),Object.defineProperty(b,"lang_code",{get:function(){return a.lang}});var d=c.find("img");d.css("left",b.position[0]+"px"),d.css("top",b.position[1]+"px"),void 0!==b.hoverOffset&&(d.bind("mouseenter",function(){d.css("left",b.position[0]+b.hoverOffset[0]+"px"),d.css("top",b.position[1]+b.hoverOffset[1]+"px")}),d.bind("mouseleave",function(){d.css("left",b.position[0]+"px"),d.css("top",b.position[1]+"px")}))}}}]),angular.module("main").directive("itemPreview",function(){return{restrict:"E",replace:!0,templateUrl:"templates/main/item-preview.html",scope:{preview_data:"=previewData",arrow:"@"},controller:"ItemPreviewCtrl as itemPreviewController"}}),angular.module("main").directive("multipleResult",function(){return{restrict:"E",templateUrl:"templates/main/multiple-result.html",scope:{result_data:"=resultData"},controller:"MultipleResultCtrl as multipleResultController",link:function(a){a.multipleResultController.result_data=a.result_data,a.multipleResultController.content=a.content}}}),angular.module("main").directive("itemScroll",function(){return{restrict:"A",link:function(a,b){a.$watch("mainController.search_again_visible",function(a){a===!0&&(b[0].scrollTop=0)}),b.bind("scroll",function(){0!=b[0].scrollTop&&a.mainController.search_again_visible&&a.$apply(function(a){a.mainController.search_again_visible=!1})})}}}),angular.module("main").directive("noResult",["$rootScope",function(){return{restrict:"E",replace:!0,templateUrl:"templates/main/no-result.html",link:function(a,b,c){a.content_type=c.content}}}]),angular.module("main").factory("item",["$resource","$q","apiClient","cache",function(a,b,c,d){var e,f;return f=a(c.urls.item+"/:item_id"),e={get:function(a){var c=b.defer(),e=d.get(a);return e.isNotEmpty()?c.resolve(e):f.get({item_id:a}).$promise.then(function(a){d.put(a.item_data),c.resolve(a.item_data)},function(){c.reject()}),c.promise}}}]),angular.module("main").service("itemTypeMap",function(){var a={1:"photo",5:"place",6:"name"};this.get_type=function(b){return a[b]}}),angular.module("main").factory("notification",function(a){var b={en:"",he:""},c={put:function(a){b=a},add:function(a){b.en+=" "+a.en,b.he+=" "+a.he},clear:function(){b={en:"",he:""}},get:function(){return b[a.lang]}};return c}),angular.module("main").factory("wizard",["$resource","$q","apiClient","cache",function(a,b,c,d){var e=a(c.urls.wizard_search),f={result:{},last_search:{name:"",place:""},clear:function(){this.result={}},search:function(a,c){var f,g=this,h=b.defer();return f=e.get({name:a||"",place:c||""}).$promise,f.then(function(b){g.result=b,g.last_search.name=a,g.last_search.place=c,angular.forEach(b.bingo,function(a){d.put(a)}),h.resolve(b)},function(){h.reject()}),h.promise}};return f}]),angular.module("lang",[]),angular.module("lang").directive("en",["langManager",function(a){return{restrict:"E",transclude:!0,replace:!0,scope:{},template:'<span ng-transclude style="width: inherit; height: inherit;" class="en" ng-show="langManager.lang == \'en\'"></span>',link:function(b){b.langManager=a}}}]).directive("he",["langManager",function(a){return{restrict:"E",transclude:!0,replace:!0,scope:{},template:'<span ng-transclude style="width: inherit; height: inherit;" class="he" ng-show="langManager.lang == \'he\'"></span>',link:function(b){b.langManager=a}}}]),angular.module("lang").factory("langManager",function(){var a={lang:window.localStorage.language||"en"};return a}),angular.module("apiClient",[]),angular.module("apiClient").factory("apiClient",function(){return{urls:{auth:"http://127.0.0.1:5000/auth",wizard_search:"http://127.0.0.1:5001/search/wizard",item:"http://127.0.0.1:5001/item"}}}),angular.module("auth",[]).config(["$httpProvider",function(a){a.interceptors.push("authInterceptor")}]);var AuthCtrl=function(a,b,c){this.$modalInstance=a,this.authManager=c,Object.defineProperty(this,"lang",{get:function(){return b.lang}}),this.iare="",this.ias="",this.message=""};AuthCtrl.prototype={signin:function(){var a=this;this.authManager.signin(this.iare,this.ias).then(function(){a.message="Sign in succeeded",a.$modalInstance.close()},function(){a.message="Sign in failed"})},dismiss:function(){this.$modalInstance.dismiss()}},angular.module("auth").controller("AuthCtrl",["$modalInstance","langManager","authManager","$http",AuthCtrl]),angular.module("auth").directive("needAuth",["$state","authManager",function(a,b){return{restrict:"A",scope:{nextState:"@",isMandatory:"@needAuth"},link:function(c,d){d.bind("click",function(){var d,e=JSON.parse(c.isMandatory);d=void 0===c.nextState?a.current.name:c.nextState,b.authenticate(d,{mandatory:e})})}}}]),angular.module("auth").factory("authManager",["$modal","$state","$resource","apiClient","$http","$compile","$rootScope","$q",function(a,b,c,d,e,f,g,h){var i,j;return i=c(d.urls.auth,null,{signin:{method:"POST"}}),j={in_progress:!1,signedin_user:!1,csrf_token:"",authenticate:function(c,d){if(this.signedin_user)b.go(c);else{var e=a.open({templateUrl:"templates/auth/auth_modal.html",controller:"AuthCtrl as authController",size:"lg"});e.result.then(function(){b.go(c)},function(){d.mandatory===!1&&b.go(c)})}},signin:function(a,b){var c=this;if(!this.in_progress&&!this.signed_in_user){var d=h.defer();return i.signin({username:a,password:b}).$promise.then(function(b){b.token?(sessionStorage.bhsclient_token=b.token,c.signedin_user=a,d.resolve()):d.reject()},function(){d.reject()}).finally(function(){c.in_progress=!1}),d.promise}return!1}}}]),angular.module("auth").factory("authInterceptor",["$rootScope","$q","$window",function(a,b,c){return{request:function(a){return a.headers=a.headers||{},c.sessionStorage.bhsclient_token&&(a.headers.Authorization="Bearer "+c.sessionStorage.bhsclient_token),a},response:function(a){return 401===a.status,a||b.when(a)}}}]),angular.module("cache",[]),angular.module("cache").factory("cache",[function(){var a,b;return b=void 0!==window.sessionStorage?window.sessionStorage:{setItem:function(a,b){this[a]=b},getItem:function(a){return this[a]||null},clear:function(){for(key in this)delete this[key]}},a={put:function(a){return void 0!==a._id?b.setItem(a._id.$oid,JSON.stringify(a)):!1},get:function(a){var c=b.getItem(a);return c?JSON.parse(c):{}},clear:function(){b.clear()}}}]);