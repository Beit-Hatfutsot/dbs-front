language: bash
sudo: required
services:
- docker
script:
- |
  if [ "${TRAVIS_PULL_REQUEST}" == "false" ] && [ "${TRAVIS_BRANCH}" == "master" ]; then
    openssl aes-256-cbc -K $encrypted_6dcdd37ad8d6_key -iv $encrypted_6dcdd37ad8d6_iv -in secret-mojp-k8s-ops.json.enc -out k8s-ops-secret.json -d &&\
    git clone --depth 1 https://github.com/Beit-Hatfutsot/mojp-k8s.git &&\
    docker pull orihoch/mojp-k8s &&\
    docker run -it -v "`pwd`/k8s-ops-secret.json:/k8s-ops/secret.json" \
                   -v "`pwd`/mojp-k8s:/ops" \
                   orihoch/mojp-k8s \
                   -c "source ~/.bashrc; source switch_environment.sh production; \
                       ./update_yaml.py "'{"front": {"image": "gcr.io/bh-org-01/mojp-dbs-front:'$TRAVIS_COMMIT'"}}'" \
                                        "values.production.yaml" &&\
                       git config user.email "deployment-bot@k8s-ops" &&\
                       git config user.name "deployment-bot" &&\
                       git add values.production.yaml &&\
                       git commit -m "dbs-front image update --no-deploy" &&\
                       git push "https://${K8S_OPS_GITHUB_REPO_TOKEN}@github.com/Beit-Hatfutsot/mojp-k8s.git" master &&\
                       kubectl set image deployment/front front=gcr.io/bh-org-01/mojp-dbs-front:$TRAVIS_COMMIT &&\
                       kubectl rollout status deployment front \
                      ";
  fi
